# 總線

上次編輯時間: 2025年9月15日 下午6:24
建立時間: 2025年9月15日 下午4:56

## 一、總線基本概念

# 1. 总线是什么

- **定义**：为多个部件**分时共享**的公共信息传输线路（物理上是一组并联的信号线）。
- **两大特性**：**共享**（多部件共用一套线）＋**分时**（同一时刻只允许**一个**主设备驱动总线）。
- **为什么一根总线能一次传很多位**：总线=多根信号线的集合（如 32 根线 ⇒ 一拍并行 32 bit）。

> 易错：同一时刻只能有一个设备在总线上“发送/驱动”；但可有多个设备同时接收。
> 

# 2. 设计四特性（知道名词即可）

- **机械**：外形、针脚数与排列。
- **电气**：电平范围、驱动能力、传输方向。
- **功能**：这根线传**数据/地址/控制**哪类信息。
- **时间/时序**：握手、请求/响应、时钟关系。

# 3. 按传输格式：串行 vs 并行

![image.png](assets/image%2044.png)

**串行总线（USB等）**

- 每次 1bit，线少、**成本低**、**抗干扰强**、**适合长距离**、板上走线**省空间**。
- 需**串/并转换**与**装拆帧**；靠**高频率**与编码/链路聚合取带宽。

**并行总线（CPU↔主存的数据总线）**

- 每拍多bit，**时序简单**，近距离吞吐高。
- 多线并行易**串扰/时钟偏斜**，可工作频率受限；线多、**成本与布线开销高**，不适合很长距离。

> 易错：“并行一定比串行快”——错。实际受频率与信号完整性约束，很多场景串行更快。
> 

# 4. 按连接层级：三类总线

- **片内总线**：CPU芯片内部寄存器、ALU等之间。
- **系统总线（重中之重）**：一台计算机内部各部件（CPU/主存/IO）。再分：
    - **数据总线 DB**：传数据，**双向**。宽度常取**机器字长或存储字长**的倍数/等同。
    - **地址总线 AB**：CPU发地址，**单向（CPU→存储/IO）**。宽度决定可寻址空间（统一编址时还要覆盖IO编号）。
    - **控制总线 CB**：传控制/状态信号。**单根线是单向**；整组看是**既有输出也有输入**（如 MEMR/MEMW、总线请求/仲裁、时钟、复位、中断请求/响应等）。
- **通信总线**：机与机之间（可把网线视作其一实现）。

> 易错：
> 
> - “地址总线双向”——**错**；
> - “控制总线是双向线”——**表达不严**：**单线单向**，**整组**含输入与输出两类；
> - **数据通路 ≠ 数据总线**：前者是**逻辑路径**，后者是**物理载体**（地址总线在某些时序下也可承载数据，仍属数据通路的一部分）。

# 5. 典型系统总线结构（会辨优缺点）

**① 单总线**（CPU/主存/所有IO全挂一套系统总线）

- **优**：结构最简单、扩展容易、成本低。
- **缺**：**带宽低**、**不支持并行传送**（同一时刻只能一对设备使用总线）、慢设备拖累快设备。

**② 双总线**（上：**存储总线** 连接 CPU↔主存↔通道；下：**IO总线** 连接各 IO 设备↔通道）

- **通道**：”阉割版小CPU“，专管IO，缓和 CPU↔IO 速度差。
- **存储总线支持**：**突发（burst）传送**：给出首地址后连续返多字，提高顺序访问效率。
- **优**：快的走快总线、慢的走慢总线，整体更均衡。

**③ 三总线**（**存储总线**、**DMA总线**、**IO总线**）

- 高速外设（如磁盘）经 **DMA总线↔主存** 块传输，CPU 再从主存取；低速外设经 **IO总线↔CPU** 直接交互。
- **优**：高速外设效率高、系统吞吐提升；低速外设对命令响应更快。
- **提示**：教材口径——这三根**同一时刻仅一根工作** ⇒ **总体效率受限**（记结论）。

**④ 四总线（拓展认知）**：**CPU总线**（CPU↔Cache，最快）、**系统总线**（↔主存）、**高速总线**（显卡等）、**扩展总线**（USB等）。

- 以**桥接器（南/北桥）**连接不同速域：**缓冲/串并转换**、**仲裁/控制**。
- 规律：**越靠近CPU越快**；各层遵循对应**总线标准**。

# 6. 小公式/小结论

- **可寻址容量**（字节编址）≈ 2地址线数2^{地址线数} Bytes（统一编址还得覆盖 IO 空间）。
- **数据总线“宽”带来的两好处**：
    
    ① 与**机器字长一致** ⇒ 一次取能装满处理器字宽；
    
    ② 与**存储字长一致** ⇒ 一次存取正好一个存储字。
    
- **突发传送**：一次首地址，多字连续返回（顺序指令/数据的典型优化点）。

# 7. 选择题常见陷阱（对/错速断）

1. 并行总线一定比串行总线快。→ **错**（并行频率受限，串行可高频+编码）。
2. 同一时刻可有多个设备同时向数据总线**发送**数据。→ **错**（驱动冲突）。
3. 地址总线的方向是 CPU↔主存双向。→ **错**（**CPU→外设/存储**单向）。
4. 控制总线是“双向的”。→ **严格说法**：**单线单向**，**整组含输入和输出**。
5. 数据通路就是数据总线。→ **错**（逻辑路径 vs 物理介质）。
6. 三总线结构一定并行效率最高。→ **按教材口径**：**同一时刻仅一总线工作**，整体效率受限（记这个考点表达）。

---

## 二、性能指標

## 八个指标一把抓

1. **总线传输周期（Bus Cycle）**
    
    完成“一次数据传送”所需时间。典型 4 阶段：**申请/仲裁 → 寻址 → 传输 → 结束/释放**。
    
    - 与**总线时钟周期**关系不固定：可 **1:多 / 1:1 / 多:1**。若**上升沿+下降沿都传**（DDR），一个**时钟周期含 2 个总线周期**。
2. **总线时钟周期 / 时钟频率**
    - 时钟周期：时钟相邻节拍间隔；频率 = 周期倒数。
    - 早期由 CPU 提供；现代常由**桥接器**分别给不同速域总线供时。
3. **总线工作频率**
    
    = **每秒可进行的数据传送次数**（总线周期的倒数）。若 DDR：`f_work = 2 × f_clk`。
    
4. **总线宽度（位宽）**
    
    一次并行可传的**数据位数**（通常指**数据总线**位数）。
    
5. **总线带宽（理论峰值）**
    
    `BW(bit/s) = f_work × 位宽` ；或 `BW = 位宽 / 总线周期`。
    
    - **有效吞吐**要扣掉地址/校验/帧头帧尾等**开销位**，注意与峰值区分。
6. **突发（Burst）传送**
    
    首地址一次给出，随后**连续返回/写入多个字**，摊薄寻址开销，顺序访问更快。
    
7. **总线复用（常见为“地/数复用”）**
    
    地址线与数据线**共用**一组物理线，**分时**传地址再传数据。
    
    - **优**：省线、省成本、省板层/走线空间。
    - **缺**：一次事务至少多出一次“寻址传送”，**时延↑**。
8. **信号线数**
    
    = **地址线数 + 数据线数 + 控制线数**（按**最小物理导线**计）。
    

---

## 必背公式与换算

- `f_work = 1 / T_bus_cycle`；`f_clk = 1 / T_clk`；DDR ⇒ `f_work = 2 f_clk`
- `BW(bit/s) = f_work × 位宽`；`BW(B/s) = BW(bit/s) / 8`
- **有效吞吐** `= 有效负载位 / 总用时`

---

## 例题秒杀（同视频例）

> 已知：同步总线，地/数复用；总信息线 32 根；时钟 66 MHz；上/下沿各传一次。
> 
1. **带宽**：
    
    `f_work = 2 × 66 MHz = 132 MHz`
    
    `BW = 132 MHz × 32 bit ≈ 4.224 Gbit/s ≈ 528 MB/s`
    
2. **一次 128 bit 写（支持突发）最少用时**：
    - 地址阶段：**1 个时钟周期**（复用先送地址）。
    - 数据阶段：128 bit / 32 bit = **4 次传送**；DDR ⇒ **2 个时钟周期**。
    - 总时钟周期数 = **3**；`T_clk = 1/66 MHz ≈ 15.15 ns`
    - **总时间 ≈ 3 × 15.15 ns ≈ 45.5 ns**

---

## 易错/陷阱清单

- **“并行一定比串行快”——错**：并行频率受串扰/偏斜限制；串行可高频+编码/聚合，实际常更快。
- **工作频率 vs 时钟频率**：DDR 时 `f_work = 2 f_clk`。
- **带宽 ≠ 有效吞吐**：注意扣开销（地址、校验、帧界、握手）。
- **复用省线但变慢**：一次事务至少多一个“地址传送”周期。
- **题目里“总线宽度=32bit”通常指数据总线**位宽。
- **Burst**关键语义：**一次寻址，多字连续**。
- **一时刻仅一主设备驱动总线**；可多设备**同时接收**。

## 三、總線仲裁

## 1) 仲裁要解决什么？

- **背景**：总线是**共享**资源，**同一时刻只允许运行一个主设备驱动总线**（可被多设备同时接收）。
- **目标**：当多个设备**同时请求**时，决定**谁获得总线控制权**（成为**主设备**）；被动响应者为**从设备**。
- **一次事务基本流程**：`请求(BR) → 仲裁/判优 → 允许(BG) → 传输 → 结束/释放(BS)`

> 记！ 常见三根控制线语义
> 
> 
> **BR**（Bus Request）：总线请求；**BG**（Bus Grant）：总线允许；**BS**（Bus Busy）：总线忙。
> 
> **BS 由赢得仲裁的主设备拉高，不是仲裁器拉高。**
> 

---

## 2) 仲裁方式总览

### A. 集中仲裁（有“总裁/仲裁器”）

1. **链式查询（Daisy Chain）**
    - **连线**：BR、BG、BS（**3 根**）。BG**串接**各设备，按物理顺序**逐级传递**。
    - **判优**：**离仲裁器近者优先**（优先级**固定**）。
    - **优点**：线少、实现简单、易扩展。
    - **缺点**：
        - **易饥饿**（低优先级长期得不到总线）。
        - **故障敏感**（中间一段坏了，后面全断）。
        - 优先级不可调。
    
    ![image.png](assets/image%2045.png)
    
2. **计数器（定时）查询**
    - **连线**：BR、BS + **设备地址线**（宽度 ≥ ⌈log₂N⌉），**共 `⌈log₂N⌉ + 2` 根**。
    - **判优**：仲裁器用**计数器**在设备地址上轮询；可**每次从上次停止处继续**（**公平**），也可软件改策略（**可调**）。
    - **优点**：优先级灵活、公平性好，对单点故障**不敏感**。
    - **缺点**：线数多、控制逻辑比链式复杂，响应需轮询（较链式对远端更快，但不如独立请求）。
    
    ![image.png](assets/image%2046.png)
    
3. **独立请求**
    - **连线**：**每设备一对 BR/BG**，外加 **BS**；**共 `2N + 1` 根**。
    - **判优**：仲裁器内置**排队/优先逻辑**，**直接对点授予**（BG 直达设备）。
    - **优点**：**响应最快**、优先级**最灵活**（可软/硬件配置），无串接瓶颈。
    - **缺点**：**线最多**、电路最复杂、成本高。
    
    ![image.png](assets/image%2047.png)
    

### B. 分布式仲裁（无中央仲裁器）

- **机制**：每个潜在主设备都有**仲裁号**与本地仲裁器；大家把仲裁号**并发地**放到**仲裁总线**，相互比较，**最高优先权留存**。
- **特点**：去中心、可扩展、实现相对复杂；考试**知其意**、理解流程即可（选择题常考概念）。

---

## 3) 高频考点/易错

- **谁拉高 BS？** → **获胜主设备**。
- **链式查询优先级**：**固定且与物理连接顺序相关**；近端优先，易**饥饿**，**故障敏感**。
- **连线数量**：
    - 链式：**3** 根（BR、BG、BS）
    - 计数器：**`⌈log₂N⌉ + 2`**（地址线 + BR + BS）
    - 独立请求：**`2N + 1`**（N 对 BR/BG + 共用 BS）
- **响应速度对比**：**独立请求 > 计数器 > 链式**。
- **公平性**：计数器可循环/可调最**公平**；链式最差。
- **主/从角色**：**谁获得总线控制权谁就是主**，通过**地址线**选中从设备。
- **仲裁器所在**：可在**CPU**或**桥接器**（北/南桥）中。
- **并发误解**：一时刻**只能一个主设备驱动总线**，但**可多从设备同时侦听/接收**。

---

## 4) 速记对比表

| 方式 | 控制线数 | 判优&公平 | 响应 | 容错 | 典型优缺点 |
| --- | --- | --- | --- | --- | --- |
| 链式 | 3 | 固定优先，近端高，**易饥饿** | 慢（逐级传） | **差**（串接点故障致命） | 线少易扩展 / 优先级死板、故障敏感 |
| 计数器 | `⌈log₂N⌉ + 2` | **可调/可循环**，较公平 | 中（需轮询） | **好** | 优先灵活 / 线与逻辑适中 |
| 独立请求 | `2N + 1` | **最灵活** | **最快**（直达） | 好 | 快、灵活 / **线最多**、电路复杂 |
| 分布式 | 视实现 | 去中心，比仲裁号 | 取决实现 | 去单点 | 扩展好/实现复杂，掌握概念 |

---

## 5) 小练习（自测 30 秒）

1. 有 16 个设备，**计数器查询**至少需要几根控制线？
    
    ⇒ **`⌈log₂16⌉ + 2 = 4 + 2 = 6`**
    
2. **链式**方式中某中间设备损坏，后级设备还能被授予吗？
    
    ⇒ **不能**（BG 串接被断）。
    
3. 为了**最短授予延迟**该选哪种集中仲裁？
    
    ⇒ **独立请求**。
    
4. **BS 信号的来源**是？
    
    ⇒ **当前主设备**（已获准）。
    

---

需要的话，我可以把这份内容做成**一页 A4 打卡版**或**思维导图**，再配两道判优/连线数速算题，便于临考速刷。

## 四、總線操作與定時

## 0) 一次总线事务 = 4 个阶段

1. **申请/分配**：主设备请求 → 仲裁器判优 → 获准。
2. **寻址/命令**：主设备在**地址总线**给出目标地址，在**控制总线**给出读/写命令。
3. **数据传输**：按读/写方向在**数据总线**交换数据。
4. **结束/释放**：撤销命令与地址，释放总线控制权。

---

## 1) 同步定时（Synchronous）

![image.png](assets/image%2048.png)

- **统一时钟**由总线控制器提供；所有动作对齐到时钟**边沿**。
- 经典 4 拍示意（读）
    - **T1**：发地址
    - **T2**：发读命令（例：低电平有效）
    - **T3**：从设备在上升沿前**准备并驱动数据总线**；主设备采样
    - **T4**：撤销命令与地址，事务结束
- **优点**：实现简单、吞吐高（时钟快 → 周期短）。
- **缺点**：**定长周期**，要求各设备**时序相近**；对**长总线/慢设备**适配性差；容错（传输出错重试）空间小。
- **适用**：总线短、设备速度一致的场景（片上/近端）。

---

## 2) 异步定时（Asynchronous = 握手协议）

- **无全局时钟**，靠**请求/回答（REQ/ACK）**等握手信号自适应节奏。
- **周期长度可变**，能自然吸收设备延迟差异。
- 三种握手强度（看**撤销**是否受对方约束）：
    1. **不互锁**：
        - 主：发请求→**到点就撤**；从：回回答→**到点就撤**。
        - **最快/最不可靠**（可能错过/未确认）。
    2. **半互锁**：
        - 主：**等到回答**再撤请求；从：按固定时间撤回答。
        - 可靠性/开销折中。
    3. **全互锁**：
        - 主：见到回答后才撤请求；
        - 从：**见到请求已撤**才撤回答。
        - **最可靠/最慢**。
    
    ![image.png](assets/image%2049.png)
    
- **优点**：对**慢/远/变时延**设备友好。
- **缺点**：控制更复杂，握手等待致**吞吐低于同步**（同工艺下）。

---

## 3) 半同步（Sync + Wait）

![image.png](assets/image%2050.png)

- 本质：同步总线 + **WAIT/READY**反馈，允许插入**等待状态 Tw**。
- 时序（读）：`T1 地址 → T2 读命令 → Tw…Tw（从设备拉 WAIT） → T3 数据有效 → T4 结束`
- **特点**：有统一时钟，但**周期可伸缩**；易实现，兼顾不同速度设备。
- **时间**：`总时间 = (基准拍数 + 等待拍数) × 时钟周期`

---

## 4) 分离式通信 / 分离事务（Split-Phase / Split-Transaction）

- **把一次事务拆两段**：
    - **请求相位**：主设备占用总线仅**发送地址+命令**，**立刻释放总线**；
    - **响应相位**：目标设备**准备好后**再申请总线把**数据返回**。
- **好处**：隐藏慢设备准备时延，让总线在空隙期被**其他事务复用** → **总体吞吐显著提升**。
- **要求**：系统能**匹配请求与响应**（标记/队列/缓冲），目标需要具备再次发起或被动返回的能力。
- **常见于**：高性能总线/互连（高级片上互连、PCIe 思想类似“拆分事务”）。

---

## 5) 高频对比表

| 方式 | 时钟来源 | 流控手段 | 周期长短 | 吞吐 | 可靠性 | 实现复杂度 | 适用 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 同步 | 全局时钟 | 无握手 | 固定 | 高 | 低（无确认） | 低 | 总线短、等速设备 |
| 异步-不互锁 | 无 | 请求/回答（无互锁） | 可变 | 较高 | 低 | 中 | 误码可接受、近距 |
| 异步-半互锁 | 无 | 请求受回答制约 | 可变 | 中 | 中 | 中 | 通用 |
| 异步-全互锁 | 无 | 请求/回答互相制约 | 可变 | 低 | 高 | 中 | 远距/高可靠 |
| 半同步 | 时钟+WAIT | WAIT/READY | 可变 | 中高 | 中 | 低中 | 混速设备 |
| 分离式 | 时钟或异步 | 请求/响应拆分 | 重叠利用 | **最高（系统级）** | 依实现 | **高** | 高性能系统 |

---

## 6) 易考/易错点

- **同步**：一个事务内**拍数固定**；若设备太慢就会**数据赶不上**。
- **异步**：记住三种**互锁**定义对的是**“撤销时机”**；**全互锁最慢最稳**。
- **半同步**：**WAIT/READY 由从设备拉**；以**插入 Tw**形式扩展周期。
- **分离式**：请求后**立即让出总线**；**响应时再用总线**；总体利用率提升。
- **阶段划分**：寻址阶段 = 地址 + 读/写命令；真正数据在**传输阶段**。
- **名词**：主/从是**角色**（谁拿到控制权谁是主）；不是固定按设备名称。

---

## 7) 口算小题（热身）

1. 半同步读：基准 4 拍，每次插入 3 个 Tw，时钟 100 MHz。**一次读时延**＝(4+3)/100 MHz = **70 ns**。
2. 异步握手：若要求“对端确认后才能撤销各自信号”，这是**全互锁**。
3. 分离式场景判断：慢速从设备准备时间长，但系统还有别的主设备要跑——**优先用分离式**。

## 五、總線標準

## 1) 为什么要有“总线标准”

统一**连接方式/电气特性/仲裁与定时/带宽形态**，让不同厂商设备“即插即用”。出题常问：**识别缩写 + 判定所属层级（系统/局部/设备） + 串/并行特征与大趋势**。

---

## 2) 三层分类与一眼判别

- **系统总线**：**直连 CPU**（或经北桥）→ 快。
    
    例：**ISA / EISA**（并行、慢，早期）、**FSB**（前端总线，Intel 早期）、**QPI**（QuickPath，Intel 点对点串行；视频里“KPI”即它）。
    
- **局部总线（本地总线）**：连**北桥/高速桥**，承载显卡/高速 I/O。
    
    例：**VLB/VESA**（并行）、**PCI**（并行，33 MHz/32bit 起）、**AGP**（显卡专用并行），**PCIe**（串行、分“lane”，x1/x4/x8/x16，点对点、全双工、热插拔）。
    
- **设备/通信总线**：连**南桥/控制器**，外设接入。
    
    例：**RS-232C**（串行，低速）、**SCSI**（并行，老牌高速外设）、**PCMCIA/PC Card**（便携存储/网卡，支持热插拔）、**USB**（串行、差分 D+ D−、支持 Hub 最多 127 个外设、热插拔；Type-A/B/C 都是它的外形规格）、**IDE/ATA/PATA**（并行硬盘）、**SATA**（串行硬盘，取代 PATA）。
    

---

## 3) 串行 vs 并行（命题高频）

- **并行**：多根线同时传多位；**易串扰/走线等长难** → 频率提不高。
- **串行**：一对差分线高频传输（常**双绞**）；**点对点、按包传输、可多 lane 聚合**（如 PCIe x16）→ **总吞吐更高**。
    
    ➡️ **大趋势：并行 → 串行**（PCI→PCIe，PATA→SATA，外设多转 USB/PCIe）。
    

---

## 4) 代表标准一览（只记“定位 + 关键词”）

- **ISA / EISA**：系统总线，**并行**，老旧低速。
- **FSB**：系统总线，CPU↔北桥传统通道。
- **QPI**：系统互连，**串行点对点**。
- **VLB/VESA**：局部总线，**并行**，早期显卡。
- **PCI**：局部/有时作系统，总线式共享，**并行**。
- **AGP**：局部，**显卡专用**并行通道（1×/2×/4×/8×）。
- **PCI-E**：局部（也可直连 CPU/chipset），**串行 lane（x1…x16）**、**全双工**、**热插拔**、**点对点**。
- **RS-232C**：设备/通信，**串行**、低速、早期串口/打印机。
- **SCSI**：设备，**并行**外设总线（打印机/扫描仪/磁带等）。
- **PCMCIA（PC Card）**：设备，**便携卡槽**，热插拔。
- **USB**：设备，**串行差分 D+/D−**、Hub 菊链、热插拔（Type-A/B/C 只是**接口外形**）。
- **IDE/ATA/PATA**：设备（ 硬盘），**并行**。
- **SATA**：设备（硬盘/SSD），**串行**（SATA 3 ≈ 6 Gb/s 物理层级）。

---

## 5) PCIe 小抄

- **点对点**，每设备**独享链路**；**x1/x4/x8/x16 = lane 数**（并非“并行总线”，而是**多条串行链路并发传包**）。
- **全双工**：上下行同时传。
- **热插拔**、按**包**传输，易做**QoS/仲裁**，吞吐随 lane 线性提升。

---

## 6) USB 小抄

- **4 线**（传统 Type-A）：VCC、D+、D−、GND；**D+/D− 差分**传 1 bit。
- **最多 127 外设**（经 Hub），**热插拔/即插即用**。
- Type-C 只是**接口形状**；协议族仍属于 **USB**（或承载 Alt Mode/PD 等）。

---

## 7) 考场易错点

- “**并行一定比串行快**”——**错**（看**频率与链路组织**）。
- “**PCIe 是并行**”——**错**，它是**多 lane 串行**。
- “**USB 可直连无限个**”——错，**受 Hub 层级与 127 限制**。
- “**系统/局部/设备**”混淆：**是否直连 CPU/北桥/南桥**来判断。
- **AGP**是**显卡专用局部总线**；**SATA**是**存储串行**；**SCSI**是**设备并行**。
- 文中“**KPI**”应为 **QPI**（QuickPath Interconnect）。

---

## 8) 速记口诀

- **“系走前路快”**：系统总线走**前端（FSB/QPI）**，**快**。
- **“局部显快配”**：局部总线给**显卡/高速配件**（PCI/AGP/PCIe）。
- **“设备串天下”**：设备侧**多转串行**（USB/SATA/PCIe 外接卡）。